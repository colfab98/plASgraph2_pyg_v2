Clone project:
git clone https://github.com/colfab98/plASgraph2_pyg_v2

Clone plASgraph2 original dataset:
cd plASgraph2_pyg_v2
git clone https://github.com/fmfi-compbio/plasgraph2-datasets.git

Manually install Miniconda and set up conda environment:
mkdir -p ~/miniconda3
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
rm ~/miniconda3/miniconda.sh
~/miniconda3/bin/conda init bash
exit
cd ~/plASgraph2_pyg_v2

If HPC: 
    conda env create -f environment.yml
    conda activate plasgraph
If Mac:
    conda env create -f environment-mac.yml
    conda activate plasgraph-mac
    pip install torch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1
    pip install torch-scatter torch-sparse torch-cluster torch-spline-conv pyg-lib torch-geometric -f https://data.pyg.org/whl/torch-2.3.1+cpu.html
    pip install -r requirements-mac.txt




Optuna:

Local: 
    export RUN_NAME="run_"
    python -u -m scripts.tune_hpo \
        --run_name ${RUN_NAME} \
        plasgraph_config.yaml \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/hpo_study/hpo.log 2> runs/${RUN_NAME}/hpo_study/hpo.err

HPC1:
    sbatch tune_hpo.sh

HPC2:
    mkdir -p runs/${RUN_NAME}
    PYTHONUNBUFFERED=1 accelerate launch --num_processes=1 --mixed_precision=fp16 -m scripts.tune_hpo \
        --run_name ${RUN_NAME} \
        plasgraph_config.yaml \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/hpo_study/hpo.log 2> runs/${RUN_NAME}/hpo_study/hpo.err

View dashboard:
    optuna-dashboard sqlite:///runs/${RUN_NAME}/hpo_study/hpo_study.db



Audit Data:

    export RUN_NAME="run_"
    mkdir -p runs/${RUN_NAME}/feature_analysis/ && \
    python -u -m scripts.audit_cached_data \
        --run_name ${RUN_NAME} \
        plasgraph_config.yaml \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/feature_analysis/audit.log \
        2> runs/${RUN_NAME}/feature_analysis/audit.err



Final Training:

Local:
    export RUN_NAME="run_"
    python -u -m scripts.train \
        --run_name ${RUN_NAME} \
        plasgraph_config.yaml \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        --training_mode k-fold \
        > runs/${RUN_NAME}/final_model/train.log 2> runs/${RUN_NAME}/final_model/train.err

HPC1:
    sbatch train.sh

HPC2:
    export RUN_NAME="run_"
    mkdir -p runs/${RUN_NAME}
    mkdir -p runs/${RUN_NAME}/final_model
    PYTHONUNBUFFERED=1 accelerate launch --num_processes=1 --mixed_precision=fp16 -m scripts.train \
        --run_name ${RUN_NAME} \
        plasgraph_config.yaml \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        --training_mode k-fold \
        > runs/${RUN_NAME}/final_model/train.log 2> runs/${RUN_NAME}/final_model/train.err



Analyse Edge Gates:

    export RUN_NAME="run_"
    mkdir -p runs/${RUN_NAME}/gate_analysis
    python -u -m scripts.analyze_gates \
        --run_name ${RUN_NAME} \
        plasgraph2-datasets/eskapee-train.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/gate_analysis/analyze_gates.log 2> runs/${RUN_NAME}/gate_analysis/analyze_gates.err



Evaluate:

Local:
    export RUN_NAME="run_"
    mkdir -p runs/${RUN_NAME}/evaluation_results
    python -u -m scripts.evaluate \
        --run_name ${RUN_NAME} \
        plasgraph2-datasets/eskapee-test.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/evaluation_results/eval.log 2> runs/${RUN_NAME}/evaluation_results/eval.err

HPC1:
    sbatch evaluate.sh

HPC2:
    export RUN_NAME="run_"
    mkdir -p runs/${RUN_NAME}/evaluation_results
    accelerate launch --num_processes=1 --mixed_precision=fp16 -m scripts.evaluate \
        --run_name ${RUN_NAME} \
        plasgraph2-datasets/eskapee-test.csv \
        plasgraph2-datasets/ \
        > runs/${RUN_NAME}/evaluation_results/eval.log 2> runs/${RUN_NAME}/evaluation_results/eval.err



Classify & Visualize predictions:

RUN_NAME="run_"
GFA_PATH="plASgraph2_pyg_v2/plasgraph2-datasets/cfre-test/shaw-2021_cfre-SAMN15148288-u.gfa.gz"

mkdir -p "runs/${RUN_NAME}/classify"
python -m scripts.classify \
    --run_name "${RUN_NAME}" \
    gfa "${GFA_PATH#plASgraph2_pyg_v2/}" \
    > "runs/${RUN_NAME}/classify/classify.log" \
    2> "runs/${RUN_NAME}/classify/classify.err"


LABEL_FILE="plASgraph2_pyg_v2/plasgraph2-datasets/cfre-test/shaw-2021_cfre-SAMN15148288-u.gfa.csv"

python -m scripts.visualize_predictions \
    --run_name "${RUN_NAME}" \
    --prediction_file "runs/${RUN_NAME}/classify/$(echo $(basename "${GFA_PATH}") | sed 's/\.gfa\.gz$//' | sed 's/\.gfa$//').csv" \
    --gfa_file "${GFA_PATH#plASgraph2_pyg_v2/}" \
    --label_file "${LABEL_FILE#plASgraph2_pyg_v2/}"




